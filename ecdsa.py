
import sys
import subprocess
import numpy as np
import matplotlib.pyplot as plt
from ecpy.curves import Curve,Point
from Crypto.Random import random

trace_path = '/Volumes/LaCie/ecdsa_debug/'
num_samples = 6000000
#98000
num_traces = 50
boucle = 20

def plot_trace_snr():
    traces = np.load(trace_path + 'traces.npy')
    plt.figure(figsize = (18, 10), dpi = 80)
    idx = random.randint(0, traces.shape[0] - 1)
    plt.plot(traces[idx], label = "trace " + str(idx))
    plt.legend()
    plt.show()


def get_int(l):
    v = 0
    for elem in l:
        v = (v << 32) | elem
    return v


def check_output():
    inputs = np.load(trace_path + 'inputs.npy')
    outputs = np.load(trace_path + 'outputs.npy')
    
    for i in range(inputs.shape[0]):
        k = get_int([int(e) for e in inputs[i]])
        p = k * cv.generator
        l = get_int([int(e) for e in outputs[i]])
        assert(l == p.x)

    print(inputs.shape[0], "assertions passed")


def get_input_for_ecdsa():
    order = 115792089210356248762697446949407573529996955224135760342422259061068512044369
    k = random.randint(0, order - 1)
    #k = 1
    strk = '{:064X}'.format(k)

    #print(strk)
    return strk

def le_to_be16(s):
    l = len(s)
    result = ''
    for i in range(int(l/8)):
        st = bytearray.fromhex(s[i*8:i*8+8])
        st.reverse()
        result += st.hex()
    return result     #', '.join([str(int("0x"+i,0)) for i in st.hex()])  // pour print en decimal


def pourcent_reussi(s,in_k,traces):
    c=0
    b=0
    for i in range(len(in_k)):
        print("input_k: ", in_k[i])
        print("found_s: ", s[i])
        if in_k[i] == s[i]:
            c += 1
        else:
            print("trace[%d]"%i)
            for j in range(len(in_k[i])):
                if in_k[i][j] != s[i][j]:
                    b += 1

    return (c,b)

def write2file(filename, content, mode):
    file = open(filename, mode)
    file.write(content)
    file.close()


# ec_p256_m31 params
mod = 115792089210356248762697446949407573530086143415290314195533631308867097853951
a = mod - 3
b = 41058363725152142129326129780047268409114441015993725554835256314039467401291
xG = 48439561293906451759052585252797914202762949526041747995844080717082404635286
yG = 36134250956749795798585127919587881956611106672985015071877198253568414405109
order = 115792089210356248762697446949407573529996955224135760342422259061068512044369

cv = Curve.get_curve("NIST-P256")


assert(cv.order == order)
assert(cv.a == a)
assert(cv.b == b)
assert(cv.field == mod)
assert(cv.generator.x == xG)
assert(cv.generator.y == yG)

c=0
b=0
debut = 65372
pois=[[] for i in range(64)]
for j in range(64):
    if (j != 0) and (j%2 == 1):
        debut += 92184
    elif (j != 0) and (j%2 == 0):
        debut += 92190
    for i in range(15):
        pois[j].append(debut+210*i)

for index in range(boucle): #[3,4,5,6,7,8,11,13,14,17,18]
    input_str = get_input_for_ecdsa()
    for i in range(num_traces - 1):
        input_str += ',' + get_input_for_ecdsa()
    # input_str = "B9AA54C18E650F2295AAE7B2A615AA41693208C88C6F34021F41C882C3E6748B,4C68DD55E127CBABBC5085CC2F7B7B2ADBCC470AECD2C464734B699052AB95DD,18287EAB9C9D9B04EA610D7165CCB664F7827A74092EC65EC8620E5156D37733,1927183132F1000659B6FFB1FEDBE9742F7A9A9E34DC81A7AEB17982E8BAFDD5,7E1123BE0BD195371279323B9141CE10E0DED4A2D19CE9F7C54DDF4DD6C07676,E79CA9100A4F28F74EE6E5F4EE2BFEF5714C46B61F14AD682B4ECA921B0AE95F,7E9DCCECFB80DDBCFDC8DDFEBAC897549296BB508FA94FEB51457E110983E258,EC66E06FD1BE8D3687A62F8F328FEF29E6665D67F3A8C68BD5865A1353C7B2C6,FC81CB2EB237745F38D7B64A76C0435019DFFC08DCCEA6E29F660EE3FFEDA13F,324F58B9142A74C85405C4973840EA1BE7136A98EFB85ED490DF07A5847335BA,6E86D109539BA4E3F7E2FD13B8B4A17E3542DBEFD105BABC0F63B4D272BDA3F8,BBA9B5ACA5C6458E2E381D0ED09BB367DAEFA961EEE4FF8FB97126FBA1E4D05C,D982056855AC329B198587813BEBD6744134F6CED10C13EC8CF8FEDE3B78DAE4,8C3A9AAE1692A8B5E5D5DBEB967065F0BF23FB7F6523B8C14A8C4DD5B0035538,1D05EBB045F7716E77CD81035007639751B7FEE7BA393F1A9E1A6CF99B935D67,FBA867B16F722F53E78C710FAD7F2E6AADBFD4B2282C5EB93068D1E9CD9BF7F9,E82AACA55660BD210B7E4322AD9056CC199039998BF3E42910C6C256D953A4B3,BB2840BC94ABEF89DC3AD221C1F5ED012C2F6C09F66AA0B650702A3255081019,D6037456CC01730DD58AC3A26B4666D97EB846B2921368C10943953A59C3A690,1987393D2C5E04427C646FD21BAE13F00EC686A9A356DF96FEE8FEB0983728CD,FBF824FC6A2F21AA39DC6AF449390870A0982940512BF79E5F343DC20A15663E,B5503E8B99E331A7448BC9CE02D5C83BFDF598D7B6C2BC0CC147F01E362F920C,9F02A31D0BAF06CD1FB7C12E8DC4EA89D9AB34440F1B0D96D4C121A827548340,1C375CC91922932129CAB9106FBC1F8F2300C1695E2E670D4F43D53876ABCD1D,6F75F39B905BD0546DA141EBE6B25EC3950ED4E411CE81E4649037ACB42CD702,27FC619ED20BECCD9BDDD3F2C5F27674B1C51E2DE94194DDD17B53AFC4027B58,95635A910CBC491E91A66879FE777C5A0BC173C7807AA65D182CB38B4FC95ED7,2E304CEFEEC9BF517B7A324D1111F8D9817F757FEBCE15E8337EA9AF8C9D9190,00782B30C9DC6B77C7605CE8005647BA1ECE1A007E1B02223A9ACFC187CF5913,D177A3F0FBA4DFFE3AD3C77F2514AD6B59CA34B33A48A4168CF6A365CBA009C7,CB1830A3B96EDAF45DA3A40C9ABF6119CA94B33314E85D3EAF2F9D76CEB754D8,B570A09C71219486339DC90AD8E21331A593E0933301A23DC5AF7D4D57D2B211,4B7F8A8F31C7F98B17B8DD0B6B1E68B2F7B0A83836D7A56C589CB86869EEB40A,402BDBB1CEFA684E1A6B6F3B6CC44A44B0FB305D7D19AB57F380622B2F69579E,E32ED7C579350E040E8540818D0BC03DC9A34B4D671DECCE861EBCE28435DD58,6DDD7EE66B6040B0F41CA126A2E7816A1EE726C39E75A8DF5A9B4EE975A348AC,32B9402AE7153FE21EF843A40FF377FCCAF514E11E93708F91AA3497EF55AD77,AD364823B98D917BC378A7F9FD012D09BEB16A1A2AD677E47C42FFB2398C599D,74A702A0C3FB84495B4CB61D0AE808C6B8DDB42551C308D0841FDC840C60A56A,02E3A619387231C93FA123A12E56D0FF3ED2DF3FE97978BA9E8403ECE208D56E,7AD23848AD79969D4C97DD6B63B6BBBEF643E339ED4C677A707132781CF271A0,16935302D2F6B37726895E2D11C33860BAFA7CFFB29F7E0158228FBE5C710C60,3F4206ACA6B73E813B7934340CD1375FEAC07BF9B6F5FF6A5990EF089FE8DAB0,7389FECBCCD184D9E357C0ED70B6B0C35DD1FFC33778F52B010F2BB6C4AD14AD,545595BCC1C130E975ACC5D74EA29EAB74AA1FB43EA659E909044ED04FA8C3EE,1CE0C0B3F7E76A5243D7AB1C0524E79AD67D49F1E8ED807108B4AF851DCAB3A4,241BE407B821EB410259F0AADAFD823261B619F4927BD85C015047284D7C74E0,A3F57D9044C764DBDFF04B0ED91C8416F22BB7047AC9354DE58BF08FD1C8AAE9,37A149D457D41EDB885713A5729D89D7BC20EF27356BDB6F9BD0EDAC5174D012"
    # input_str = "FBA867B16F722F53E78C710FAD7F2E6AADBFD4B2282C5EB93068D1E9CD9BF7F9,E82AACA55660BD210B7E4322AD9056CC199039998BF3E42910C6C256D953A4B3,BB2840BC94ABEF89DC3AD221C1F5ED012C2F6C09F66AA0B650702A3255081019,D6037456CC01730DD58AC3A26B4666D97EB846B2921368C10943953A59C3A690,1987393D2C5E04427C646FD21BAE13F00EC686A9A356DF96FEE8FEB0983728CD,FBF824FC6A2F21AA39DC6AF449390870A0982940512BF79E5F343DC20A15663E"
    # input_str = "0FAB6EEFD0B722F9BDF3C9E000F6BAD01513BBC98978241FA15689BB314C316D,3CC9BD6A2AB3AFAF8DD6F31A718EF16BFD5D43F310CE64D979040CA1E9D85FE8,407E59585A04C228F85A2DEC2F4F6F2F7245578CD5B07EDA756D666739440B0B,7507A3B94347B38E804CBFB7B4AEFEA56BBD7D864D2704834CCA302EFF9D7286,B01A498C52A7B6C48D71F5D0F333E1CD19486458444BCF87947CB13CC5E7E76A,667610662A4631F2AFE27B3877E149BAC4EC0211F401FCFB031E479A51F9B6F6,EC66E06FD1BE8D3687A62F8F328FEF29E6665D67F3A8C68BD5865A1353C7B2C6,B9279F74AA67480FF5384F36A57BE0D2797AEB8449B5B7F2D8AA3D1656637BEF,59C77365D22639A396D5EA885B5E6557C91630B878831A4FBDE54FFB42F27750,73D9EC2116FC7362BC87D4F531390FDCE1DE946AF1C91A7EF24A11F1F2B07BDC,5153FB68A324B4BA37FC2EC8C6DFC03A833E187C4C2C2039F49EAACC882CBD85,6C1603C390C5292B3B4B146A6F40ABEE2A096F4D0C807A4F6077FA6A1A06F63B,A6143BE70FDD24F8DD84675D71E8203D0C901AACEAEAB60CEB7EC7EC284EA9C6,CDEAA7A446E2D9D58248A9E88196233EFCFF3D0AB050B2093AACE82EC82F2A75,E9FD65EA276D0E036E9EAC0C6F38FC6BA74A5BF927E53E6C4B0F38CF97E0CD5A,DA3CD5A0D5E232458377F6B8E0B57E4FAE32DC9AF61C63A109B08383326EFE36,7FED8C362F58876EBED950CA6488402ABDBA085E56DEA63E3F9E5C0DE7F6E3EB,F98FCC4F65BE5B407329E4347E869856B49CB4806D7F858BC23C88AF4AD5DD92,63D9C720B6B67A59846CEE1A10BD2FE161D93F9810A1039E783E4706FAD8592C,2BC9394B7552AA8D74550A7DFE07F0DD704F92408A4E27995AD9725C6A7338F6,CB437819CFEF2167CD4B8CD594A823D6BA2ABFCEDEB8086FB8011A82BFAE38A6,B2EFD8F50A1E0A920B3E368310AEAE0951FE1F0613116CDD7574042684974E62,619A095BCF303E372FD6952E4FF933F89107A76B035F07FD1CC0F5926A68967A,A06EEC8D66E06E47AE87B61951B101E319C13E65E349871F65A4D78423AB7A00,08A4B0A904DBBDBFD286E0641141E106C6F0FC203E5C6B10D0EA6889B4BE0A4F,222E8CB9303F452399179AD04CB69BBC911275B52B475E561A01615572BEEA63,1C573BAC106D316B472FC46D1D207DA1AD1FA5F0A9111A0F7FECB4DF60CB06F8,3E64499995391C5D3EF16E03B42D769C31DF8DC44F75D2C3E7F193814F82D8B1,1E78DFAB293B20C4B5EE38A1A040DC99D2CF388A007D33A3DF625FFE069C4DF8,6DD62732F09AA825D443882EE3666B5907A1948F20C39B263F5604BCFA1062D4,AE328E8396D080DA636CE333B9BC9D573A6E0359E6AFDD373A4A7742F4B83F2B,FCF6D37986824B02C6332B7EFCB32E6E714A633113B6E43C65E6E41C2195576D,A604B4F1D172D606BC431B816621CDABE1394743546C641E83DD221F469D17E0,37B25B282C163902C1D004FDAF14ACFF8D859FD9DDD58A250634FE8193B09899,40520D96BFF7C597B28B54BAA67E1B66D8B9EC3EE50E2251C44BAAC6C23CAED8,A1D4CD7BC952E622E0F035E9EF8788843D5A0EADC6B6E1146501BE7639948BDA,D0210599BB1CBAE82A06D629804F4215487AAAAC6159636FEAFBF89C676F8B58,7765FD9E81AF1E3F0C5013DAD2A4DD01FD7881952EF19AC5E982243C8CC4A52D,40EED05A8A7E23A7AB53524369CC55C6EB76C2558BAF17FF7789A0EFD06382FC,CDBDAF937BFB2A638737AE1799885D51EA93ABEEADA0AE46459F0AA65B1DDA3E,95C23A85630B30C0F4FDAB47AF6EA88E15288B7596F670F590E72BE36D769DB8,2DEAD4E8BB65A0F76DB75DA6B9ACCBF2F6EEAB0515030EE06D039AA55169AFE0,776278D5EAE8BE1D06E3F2B00E82AB53B19016C14FE264E49DB1BCDD5403444C,91892AE81654E453264472767F16EEAC51D3A4B0C2355117486ABAC719A076DF,BE3FE479F87307D5E5C7A6B0CA63341AD4045FB53E0EF0081E3C2A02E6BD3415,258C7E089FAA1BDB2EA99468BA7FA758AAE46CF775F1D54448646E3637CD813D,89886CD5F56A5EE961566F898A18280F3A7501D79684511CD0765A7AC2DA1356,C6F6355FD21FB3D2A520304A01A02A017960CEE25D4CB0913FCD68C137D5BF11,84EEA62FB1E095BABA95933E3AA88FB4A122E9CB30F0C094F2542FB73FCBC50C,CF6A806EC45FCB6FAD03AA0C83C2ACA8BAEF1C8FBC13C7337C3D9D15C57BF637"
    # input_str = "7E9DCCECFB80DDBCFDC8DDFEBAC897549296BB508FA94FEB51457E110983E258,736C081068B5C26C35FB504E07376715327E908533C73793A91588425AC414AD,750898C9FCCEBFF1E655FEB3A9D9E30BD537F546A166188EF1CE1EA77C015F76,06F744DBAF9D306021CC1B21C686FF3EAE16C5A16F16D69D2B62EC81DD1203E9,863348EAE56357891EC09D5AD63883638FBA5CC48BF19BFF569677538BC3431F,28CC404D680C232730508948D728DDAECDFDE3A573115948E6FDB17873E98E37,EED6E297557EA38241132F4B2FDDB7946D8B93805AB5030A4FC3E6A7822D0EB8,FE9DAE6148A5F36464D5C5C6F82D105BA602923D7F060BAD61C11BC6B44EBF6C,8582EA6FC5D57E06B021B138650B3A296E4EA4F943F89E87BA0361B14E8E2CB2,5A4F9A88F1392742D56EFAFC8170DE9BE081B1A936D3DD4169702B85A4463ADC,B0C37650B940318C593DF6E2FCC70B4086F7B2D2481D6B2F87BB6D66101F340F,7B4EC0D2F2E693EA56A5AADB06B2C69157387F9F2534491AA238F7F087828A75,09AD312FC2E89409172C815D16C9EDF46EEEE93BF0A4E84B0B426B2F751B7419,086FCBF732AB625F9E577DC45308F8167B517407C7D5794D08136332660721F5,F1C8CB4B78E704E3C1CAAAB137079508786C27AB302814D63CB26348E69A5524,50FFC29A2E6150A0A1552ADFDFF10A174CF04F4ED0FEAEB9B1ACC3FC3E3B45E2,EDDBF38FB851E22812649313E533C820088A2650CA3C3DF19842B073D1D79135,F778D0D86B7B7FE7A609B9C2F5D70E88EE26BB4C92145CCB91EB28814667D70C,E163B08287B9CB82F8C7B70D91D0E88709E73509095A935E8D7947163271D3D3,870D5A8719FA5C4B4E333440F8D549D2F8E4F96D842B207C2F6088425A47F2BA,EF83C68EE07F5D22AB438102DDB01B4A8CEFFB566894966E1B5989C61A81A185,894AE2A0548E3754A497A83A82172F4DD0E80DF67E56A02413ED06937307FF17,04274DF3BF153C713AAF0AB2C424551A79FD906085DAC6C8A1A7ADAFCF4B4086,68F340E6803D992E4ABB7E9AE7B01DB0393806B8D5C7BA29D2AF71DEF9F740E9,DD40D2CC2DDAB04DDBAC17B0217BB6799AD0792114C8D1C289E52AD42B2AAD9B,DE0E17E0392DC8E7F38CED3AF1086938C74A9EA379F781FEFAB455B099301A66,AC7BB42DE2B6AF4225509665E5398C420E09C091CA9DCD959904E9BF83008463,EC927ADC9EFF642DE7C0CEF9AEB9A79061C858B4132D7D80C9EA4470479E9BDF,C7B2DE4A752759F33F0180BE3496DC325FE84A1206D76E41ED41AA653B4B0BF5,5E0C9788C07F0CFF541EA464D555615FFD15863BA08C0016EF3006A3FF10EE6B,64FBD6E41331895DE4715A25EA862774560E83879B324234F2C5AC1E62445CCF,827566DD365B81D29939330A069CC20FD541C4957616CB976715EC532D18F2D5,45E329D64D0C9D5E2CF072C6FF1AB77F6E60DD4D86CD4C63AF984FA985083C88,196D2489EDB6690822543616448C6489FDC56EBEEE3C9FCF1696841E0F1A4278,262A17F836812E98471B27C10D21302EA3EE34C5755F27C1D12605CD588A3ADE,4730C84DF64D709D1B1408838C51D081F404B633EE5F8BE641496BC961ABC9E6,43B97C93D0D4BE96CE4874FF2BB6FD92F558605B49CCC42CA4DF90443F206A00,038796809C6A5D7439367ACB2927D683A28934092C296602EA475E46C5E7545C,BCF97475A5A37727A74A4A06D4D58F014BBB9A54062024A621547DD335E67B7A,1A3B8BCC4239949E2605559F383F596846B31BC067535B3FCC81393210536A3D,026AA11FD21208B1138829FC9D77888C2E5F56AA33867F995B292E7472D4C83D,1E2728680DCE26AE983E90360BC42BA5B4400934BBEF0A27571642FCBF57F24A,202B6BBBC1191165B321A5E031311E14FABE65B54356C417B92BDA0261A0D9C9,C40DD41E47B0A0E082AAB1A0B54B7E41046995B21DB036282851617AA2BEA0C7,8D664641A056C32865C95863BFFBA30E52D5D345D8F5BF85E5DE3C97AD2F4399,90AD96390A000890BFC40267AC51D63FF9601C1037D162E5B50A283712A0BD4B,26ABD349E65576C2F0640A6922DA795EE7D6252D84334873C2A68859B42D65B2,E42D46F9DCEEAD8F298DB6769886E758A7CB09FEC4E9AB37AC2CE394F887B0EF,38CF82BA848E117CB413ADD2B1E37B364BC00666B3AC7E239A0919AA91E5A823,00C43F5D13BDFD47B55F70014FA6E014C056D12525655D2E4EC112DAD2AEB4D3"
    # input_str = "7CEB6FD5A61B9035B3C7B315DEF658E066E37FBF432067D2675108F4D2398C1B,2773D90D27B2AB0C4FA2D905989BC58DD18A897241B357957F510DE3F1613B43,174278C8EC338E129D4A3A138F1B59CA457D9D95D0A1F1DF0633ADCBCC057A08,6A73EFA174535367E16CFD6C7F24DB0CC5B4B1A4440B4D3AF64A3E2591A260E4,87E62CF7CCAE53C323DECF9F861F739F06F0D42C971A587BBDDC335E42D072A1,FBA4D07AE9946650CB57DD10466C3A25FB68E2E69F48E3B74CD5AA21108064D3,C7131E1EDC6BD9D928222A0B3F8114DCC82E48A0B72F096EBF6936F6C26C64B5,DE70B415CAA4D51FA8C113463C1E11235C91108C871B88B3E98BB74C902CC22A,5AA756589CC2EDBB1C26BFADD410FB3C964D9BD413742D3B96C25601922C3B15,3853CB5DD24752AFC577C8D208429EF4EBE5AD36FE80E4BE1584D1FED133A208,7B9F2CD6B39FCB797D07594E53C0F739D65388BB752B542B25CB5AE8751BBF77,60D0E810F314E709AA10B46444D6A45EC1EABF7F63C04F3BBBEAF034D34D0160,278A0375126608750E3A5CBEFCD1FFDAB2B54773B0F9CE63D6A4EAD05F6A1F49,81EF80624BF8B54D4942D8D570F2403B6057A4BBB50B9528CF17B0099DA63031,48DB829C26CA4830BF04E1962A066E388A86835B983FCCA001B32DBCBB35473E,1360F5BE1A6FE5708125A6BE64491E0B199A25F99077509587AB99C4D5C5F0E5,08AC83807A9D2F326F489BA0805504A9DD16C039B3277319163EE98593596827,4584E1DBE937C4674E9110ACF1E13EBC6D7D56C5322D4CCEBC5295539B3FDCED,8E151CDAC3F8610C705369E6687C58024E7FC076B1BD13096CA4319226A4912F,DEE6511F02AD5F73BC2C10B4CE74FA134CB4DF3CD4B00788F92588194FF510BE,B7D0532267163578268610E8FB086509D0C4DB1D4431C64BC759AB62889502A3,371B870F42103B8C3B14D217A29E97461D7CF86EEF892F5AE42473F8E656568D,F1AEA23C707449A9E61EBF37627030F1C0F8472268B395534D377013B442CDB8,6D2BB04D0FDF26370B80856F1491FC4D434C0EDC97EC3814B785732D0F5D7292,D6944390D5E2AC3F2F0D833F94E0AB5527F3E61BF873DC6F700870AC47502BAD,54541F6F89F21442C790B3C619C5150F13DB769E45AB4D36F17E13941A37FB4F,26502B725B03B8D3C71F95D01EC896BF6B900824242A12B167B2A13D6CE710EE,AA3C4C5745F33D72EAAE9B5B120872D0AB22E6C16CAF3AF092BFF394F6E11B0D,8ADF505D1BFE43A4D9E68875FAA9489337D93F8722AA10B9A4273035BF23C5EF,E79CA9100A4F28F74EE6E5F4EE2BFEF5714C46B61F14AD682B4ECA921B0AE95F,6EC36F0C8E6F8711E4368A8D0372313BF7D102E33A2CDA7E6787F85ACF0C1A40,0EF3B6B12351F6DE4C03ED2B7797DD05D3B14B234F5FCCF4E39440F733CA05ED,EE58FBD0A2412A509ED01F503205F221F1B2F302C60EC54E8612D4212B906E20,767EAE4C4AE8A063825AF1EE9239835BB8DFBB870C0CA775A301957FCFBFC9D3,2651040D5B96381907C991AF44505FA154AF7C2AD2858835A1EEA36153F01E80,19F233503BAC25FA6D15437F34CB14EB337DCC1AD660CC06E8FD4DDAC5FC0EC8,A590D8516DB519AE07B437569A7BD0CF1533C2212C5C35300EB75839AD78C77D,EC2280138728257504B9693BCBBEA36D6FDABBF97C924A3ED45B317039D7BA49,59E7EA7A5865A0EC05294932590BAD0799B8D3EAE379187E5A957C7C8A929274,C48965F933A2218E3EFAF3B0F7E7EB950C1EB76BF567071131E60A7DF0E997B9,4F9F024DF2D1D9384F3A17A7A22DBA1AB2D24846C05CE4907B0E730D20FAA60C,4682653100C105140DE2FFBC8F96D4B29AF137932CE353E5B4E1075B6CCD66B8,43398FF40C9260A4A2ECCF43A8DFB0747D2A47C3E791A3DDE33135EE87EC4E66,12D528C2A1E8CAE0C12B8F2E69514C37582BA75B2BA929522C5E3BBAC15DB291,42F4D413F8F4706AA2A16781FE6FE2F73D9232C30C3E1D4124D276F3C33C3CB8,F6DC405BEEC16AF4E8A1D4FD097D54F8E76B6FFCFCFFCF344B33F07A26AEFEF6,E6C181D6A61942141677E6C324C8091643BA6744EF43709EAB582882DB68BC8A,90FDAD31EA300DF0EDF4EA8AE19F8F52246CE7E319E4DE0E373BDE313AF72503,DC342262D77FF05CD74D7D9D89308C4E6BE3CB80DC465C8B3ECE233401BD734F,9826FEE36A98F0253FFF42B4410D2C11D9FA9F3497AC20BDF9A3567FD9CB2041"
    # input_str = "B94C6FA64976FD53CAE2C0C41A628662CA01C39CACBAF1AA8B20F144FBE89F8A,CC73D1BD3CF27181DD563DD03FB1E4231F2711D1208AF262A04E58A0BF03A882,914465C00583CF2CB0516C88C5DA521043C6B189BA2FC5175F28873E93EA4F39,653130FF34AEC86A0786333B47453390D22C4115ABDDB501B31F77F5CC7F7916,0138F7C447A689FB7B60809C504A9F20731D886276A776A756BBED190FA6027F,804FDC8391CF98DAC9FC86DD5F247E7D280D98F519D8E23A1156F966DFB1D50F,1AF3214BA8864BC384C59515B29C4AD8BE496454776EABA61FDE6E281569590D,CC8CE070EC596CBD5A438A8398BC2A930CB225A8FD3EBBA110C5AA27BA549F80,ADFEBAF762746F1DBF94CB9A739E3AE97EEC4CE8D7BEA9502D93731D4311B1F5,3CAEEF8D1DDC94BFF9959BE51B70B9A8E125492DE5FD0518F9A51F5AD254A34E,7E1123BE0BD195371279323B9141CE10E0DED4A2D19CE9F7C54DDF4DD6C07676,92F0558675BBC7A459F89884617E83CEC731B8F365B4D65CFBCD9050AB18121D,31CF1C4D2BF5401D19F9E7BE7EE4FCC3AFA5329DA910B193AA1EEFB68290383A,B36446097408B74AFD8DAB9616AC3661147F4C0F0520EA7F39E2E9ED241CFC38,074C3E5F1B49110173660B5DA1D8BB877456CB9450683374AA696CCF0BF929FA,1927183132F1000659B6FFB1FEDBE9742F7A9A9E34DC81A7AEB17982E8BAFDD5,AC97C0410B5F76E7CE01A24B27FDE89C9FE0E31A84090760904AE563C2D438D4,BD1C173248BE3F835BB633D5725E8BEE2CDC021F51BFD34F04B2F535B927AE42,C33DFCDEE4BE496AE2A593DB08A163B9C7E2804B1E699788B5CC2E5DD4561B01,18287EAB9C9D9B04EA610D7165CCB664F7827A74092EC65EC8620E5156D37733,0DA601BCCA251B02065496DE96DE63C607B41D033177F8186A0C1B772FC2553C,0B8B43D1C382BB3A51D8DEEEC293B94F8BDFDE4E34705CA3F129A025088D7F8D,BC97EDC5E5ECB2845FD4B748B9C643FA9950844163642C2258066EAABF88A0D5,B489FE1594635B9AC1DAD7BD6D7F6E50871A06BA23CB4CF256AE8B56417ED776,F2D5BD486580B3187B2CA11E9A85D3D1F7C0384C8C4801B6D7D3A71DB7FA5DD8,29F785DC925DE086F31E9FFB81257E95B5F6CA72D7EBC3D60136394390AC15B2,9EB4EE0E3A68FAEA95AF0BA6EB5D17AC376646677F1FBEE21C42E75C915C62ED,4384904F79CC703EF130A0B6B0FDF3E24C96114A9E520A5D175B4EFC9ACB8C56,143896D393BC293C180378C426D899B35B2F2F9EAD0715432DFCF7B010D1CF21,4A7035A93C888571B9FF95F2452FC395BA17938E61DF4069C5252DACB4EE7E6F,3C40588CAD79335DE45BCC2E264849D88EA1AD88234F54583AB3505FA2443EAF,ABE862D6D4AE8B5CA709AC28FFF053416D1AA2EF06B5CACE49C3DFFE1FB0970B,37D71334BC8032F3D42005266DE83E7EFCB39F4FAE931305A7774B15130FC188,AD1C0A37CCF12049171F725B27D16BD5B39502D582C3837993B4B6B6489A7D55,78832E6A0F3075684E30C8A3FE5237817E9F765745BE658DF838F392C79943A9,D049AA447F7EC0608CE170304551C2D4ECDE2C80494CD6173192E27BDA189A33,E31224FDEF31711AE68023F0C2400908132B957A10D4282C813DB39AC582CA8B,B3528FCB5DBE2255FD474A8496110E74041E7FE70DDE0B4648C3FDE8D5D09769,214D6198B8C68D726327B87D8D5CEF51BB9CBED258BA2CACAAF41215EEBB2B21,F931234F3BBE71807960E1C3A63BC2035BEF38A0BBCB2DD7810B79EC3EA32DB8,01EDF8CC9ECC35C99E982D77EB4A6F4954394478C3C5CACF52BC6A1CEF1C1C8B,ABB6571297BD157EC049E03EC2BADC73E09C1E29F2BC98CDBE3ECE10C836786F,CE285436BE90FEED4F491F333A60466977BB099C6172D3621AF806AB2CF4DCD7,4C68DD55E127CBABBC5085CC2F7B7B2ADBCC470AECD2C464734B699052AB95DD,12A67F2450923F265FCBFB5BE74A0094B9FA697F34B4AEC2BA7730D53313C49B,4F9BC311DE78BDA0E47D1D5F662CD77C0AE817EE775C4A40E1A0659BC32024CE,F8628A0C728277FDA0B5200F8B85AC6B604B7F87B8BE758A89FF7715056FF5CE,4D52AC2B984059C61C18B3A7CB03C26A53E560D899F6D11292ADECB73210171A,F3EDB293B3F68C630CA483C9274DC7B354A20275164FCADEFE23C20989CEE0BA,F625AE27244E85184126C3BA6D0B5015609D48FFC0BF47B46FED3A29CBEF8874"
    # input_str = "DE75A5A80D4ED4523E33E1D0BDED1D46D1B5776FA529358854102C250C699FA3,D8CDCDC07586048034240BBB234B4D6AF661AAF29F0BF9934E67747A5A1E82B2,B9AA54C18E650F2295AAE7B2A615AA41693208C88C6F34021F41C882C3E6748B,4B8E7CE19FBD7F772E28D2F59D7EF004819CC473782240480CB0B0125AF36455,338FDE32719FD9C6EB926D05ED6E1E18115C6F477B6DA4068BEB0764C183B817,B04011B92A0E5A61FEC1EBB898664132DE67B6FBC0B49799D731BAC8B2D0054B,BE040A9598F87BC445C38926DFE0C812054030E426A1BF1EBEA8971F2C353E4A,1238466964505EF5C1FB0192B8B2AADFD375D9B4F878BF74031C118E248B1C04,A4F2FEFEA637E54C2B72B43AE7D75F698D783E64F2AB9636911566C0AE0326AD,0B9E0401EA3430965F25A50BE90F014786C8F929EE2BD3CD8A8511BD0B297E54,49C77A869FB4011B6BB1EA082C1B9681A832D6791026AF36FACCA970D1A220E9,8C0266410D387FE69B5D19BFFD86D4B3D280BBB669588775934F4D8804B79797,9BA7296BC4B8CEA344C7D7BCC8168CF01B20CCAEA9E7205789198AD3EB1A289A,8E148BA7CF36963C94E9297ACE04167B75A71D0201C3932D5C0A786B63F99C89,0453CAFE1CA14EA7CCB97CFD6BC55A1C7704F6E30A0D4CEC5E64EAD31FFFD020,A5745D9602776175EBC5EF6B60B4802CC7EF0C1A9DC784C320C172578A00F6D7,D2B7DD7A5BC2534F933D74B5300F46E39DA98B7E12AEB958DDDDE765E2D04AEF,9FEAA3050801CD806E69B65C99DC1C8D8A53057D81259D1C0D01B5F1DF6551F1,93414DF84C60A77343225BCAD3BE1E6FD0BE2BA007049BFDA34A7073A75D01A2,7B10FCA85A3A727C53B0219DA9AA82A54BA92EC058D6C7996D928ED3BDB091F3,630BC7CAD6FAA5845CBB9C54A0C50A2FECA2C76D147240ABC8573AD666217929,005226C6E761CBFB1A48B09BE458238B7B1281299F0360BBECB3F1FBFF8CAA7F,E4434DBB614101931B593BDE35CAE26E799DABBAA5DF5E08AAF149F3F9F4E595,2AC8B98DFD3C73EBF67E1A8A7F4F1DE77E30C9F619FC63A2A82242BBFB8C66D8,CD34FAC767997E5D9B8FA7B0117A319038031D64722BBF0C80C3F071B07DC68B,4F1BFE48356D3D6BB7DFD63D95B0DF8F80DA486048E067C4D99C5CA0E1825B40,33323832C8F86B32D31F68FD64982DC74EE7C66F475EAD4707F2247FA14B607C,AB017D69BB9D015EBA8F78EA95F51D3E3C9E19BE02EE11B5222FCB6786087552,F7B0CB3B26ABBC9A8426B1F14CE018997DCF7D7ADE86FF3E343DFDBAE000DD76,3B1C894D9A2E72C33568354178F455DC50D73381C2594965CA51CAF745DFD6CE,436ACE4DADB6267AC429FC25BBE23CDFAE9E9B0F496260C1A8F41E6902B68470,0365B3E013C0619C2E01EA4C8132BB69E39451FE93DD1FAD0DA4BEEF269244AC,C05C03B74764E694F4A2B17488EE05808DCB568FE73FD73EF6FCCCC71649F27E,7A4A5DB8DE7BCEE5495386AE7BFEBD41095A66A64C1CE0B70E89F302CCF8137C,58C7B6254585D2B78D4884C984906FD8853041DC44FB8CA297A3E045CBCD48C9,E8595651E4E0AAFAAF0B34403A3F98C3B1F0EFC3CDB6F38FB8D936B3A38E8282,75C9A03EC3FB9E417224D07AE591E1E2448A19B34C74BD198E9FB1CE6B569D3F,67AFA72638AA89032794733A2D8F7786FAF1A2A3C304003F313214D674E883C9,C9F04F2D6A5AB34C97B7E5B39672C6F9B6E87AF9E2A4DFED0A58F8B2121C04DE,DF4CAD188A3EAC94AB51FB4EDC336D3DA6B1605ECA0DB3C3CE85FDD80A816DC4,E1C93475F1D78574D9BE6A4E60E1D6D6C20867889845445D2746A7ABC337380B,A27DAC658F7A4910A3370B50FEFC92BC057B3F3A5AAE36486381AD20D179F0EA,EACFDEFAC8635F761B04917C9C7635451CAC1DE036C00E18F553CAB58B77AABB,6753560A00DFCF814D312667949346DADB0B9567918C249BB804EEC9DF50E575,E2AFFA5D0E030D7C91DED1907C09CE890A866B31F96656AD7DC2775290C5BE6C,05501A5510FBC306988908EA3377BCF31FBA034BE88A9E6BD7387EE47BEB50E5,DBA2DC0EA55CFB58E6BB0D5AB73873C2FF6C589C3A02413129EFA6A0C012BF56,B016E2FEE2A8FF8BFF86FC97D7054CE5DC348A6202875AE6615E740D8ADA06C3,EFD95519669932FE23D00D8673E164D16304FB72D3CBEB0DE04197A5BE8712EB,2062BF0742946BFD2DF40430CC0F85183704D60826F2DA9A04261C8B56670039"
    print('# input_str: %s' % input_str)
    d_file = trace_path + 'k_values.txt'
    write2file(d_file, '%d_%d: %s\n' % (index,boucle, input_str), "a")

    #cmd = ['python', './server.py', '-v', '--config', 'server_ecdsa.cfg', '--input', input_str, '--num-samples', '%d' % num_samples, '-b', '%s' % trace_path, '-f', '../build/apps/stm32f3/ec_p256_m31.hex', '-c', '%d' % num_traces, '--save-output-buffer', '--pause-before-reading-output-buffer', '%d' % 10, '--dump-output-buffer']
    cmd = ['python', './server.py', '-v', '--config', 'server_ecdsa.cfg', '--use-streaming-mode', '--input', input_str, '--num-samples', '%d' % num_samples, '-b', '%s' % trace_path, '-f', '../build/apps/stm32f3/ec_p256_m31.hex', '-c', '%d' % num_traces, '--save-output-buffer', '--pause-before-reading-output-buffer', '%d' % 1, '--dump-output-buffer']
    print('# Running command: %s' % ' '.join(map(lambda x: '%s' % x, cmd)))
    ret = subprocess.call(cmd)
    if ret != 0:
        print('*** Error running command, exiting')
        sys.exit(0)
    
    s=[]
    traces = np.load(trace_path + "traces.npy")
    ## sauvegarder les traces
    cmd = ['cp', trace_path + "traces.npy", trace_path + "traces%d_%d.npy" % (index,boucle)]
    print('# Running command: %s' % ' '.join(map(lambda x: '%s' % x, cmd)))
    ret = subprocess.call(cmd)
    if ret != 0:
        print('*** Error running command, exiting')
        sys.exit(0)

    for n in range(len(traces)):
        secret=""
        for j in range(64):
            cons = []
            for i in range(15):
                cons.append(abs(traces[n][pois[j][i]]))
            if cons[0] > 0.194:
                secret += '1'
            elif max(cons[1:]) < 0.131:
                secret += '0'
            else:
                secret += str(hex(cons[1:].index(max(cons[1:]))+2)[2])
        s.append(le_to_be16(secret).upper())

    compteur = pourcent_reussi(s,input_str.split(','),traces)
    c += compteur[0]
    b += compteur[1]
    print(c, b)

print("Le taux de reussi niveau trace: %.2f" % ((c/(num_traces*boucle))*100),"%")
print("Le taux de reussi niveau 4bits: %.2f" % ((((num_traces*boucle*64)-b)/(num_traces*boucle*64))*100),"%")


outputs = np.load(trace_path + "outputs.npy")
inputs = np.load(trace_path + "inputs.npy")
traces = np.load(trace_path + "traces.npy")


print(inputs)
print(inputs.shape, "\n")
print(outputs)
print(outputs.shape, "\n")
print(traces)
print(traces.shape)

check_output()


